{
    "version": 3,
    "file": "Chart.js",
    "sourceRoot": "",
    "sources": [
        "/src/renderers/Chart.tsx"
    ],
    "names": [],
    "mappings": "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",
    "sourcesContent": [
        "import React from 'react';\nimport PropTypes from 'prop-types';\nimport {Renderer, RendererProps} from '../factory';\nimport {ServiceStore, IServiceStore} from '../store/service';\nimport {Api, ApiObject, Action} from '../types';\nimport {filter, evalExpression} from '../utils/tpl';\nimport cx from 'classnames';\nimport LazyComponent from '../components/LazyComponent';\nimport {resizeSensor} from '../utils/resize-sensor';\nimport {\n  resolveVariableAndFilter,\n  isPureVariable,\n  dataMapping\n} from '../utils/tpl-builtin';\nimport {isApiOutdated, isEffectiveApi} from '../utils/api';\nimport {ScopedContext, IScopedContext} from '../Scoped';\nimport {createObject, findObjectsWithKey} from '../utils/helper';\nimport Spinner from '../components/Spinner';\nimport {\n  BaseSchema,\n  SchemaApi,\n  SchemaExpression,\n  SchemaFunction,\n  SchemaName,\n  SchemaTokenizeableString\n} from '../Schema';\nimport {ActionSchema} from './Action';\nimport {isAlive} from 'mobx-state-tree';\n\n/**\n * Chart 图表渲染器。\n * 文档：https://baidu.gitee.io/amis/docs/components/carousel\n */\nexport interface ChartSchema extends BaseSchema {\n  /**\n   * 指定为 chart 类型\n   */\n  type: 'chart';\n\n  /**\n   * Chart 主题配置\n   */\n  chartTheme?: any;\n\n  /**\n   * 图表配置接口\n   */\n  api?: SchemaApi;\n\n  /**\n   * 是否初始加载。\n   * @deprecated 建议直接配置 api 的 sendOn\n   */\n  initFetch?: boolean;\n\n  /**\n   * 是否初始加载用表达式来配置\n   * @deprecated 建议用 api.sendOn 属性。\n   */\n  initFetchOn?: SchemaExpression;\n\n  /**\n   * 配置echart的config，支持数据映射。如果用了数据映射，为了同步更新，请设置 trackExpression\n   */\n  config?: any;\n\n  /**\n   * 跟踪表达式，如果这个表达式的运行结果发生变化了，则会更新 Echart，当 config 中用了数据映射时有用。\n   */\n  trackExpression?: string;\n\n  /**\n   * 宽度设置\n   */\n  width?: number;\n\n  /**\n   * 高度设置\n   */\n  height?: number;\n\n  /**\n   * 刷新时间\n   */\n  interval?: number;\n\n  name?: SchemaName;\n\n  /**\n   * style样式\n   */\n  style?: {\n    [propName: string]: any;\n  };\n\n  dataFilter?: SchemaFunction;\n\n  source?: SchemaTokenizeableString;\n\n  /**\n   * 默认开启 Config 中的数据映射，如果想关闭，请开启此功能。\n   */\n  disableDataMapping?: boolean;\n\n  /**\n   * 点击行为配置，可以用来满足下钻操作等。\n   */\n  clickAction?: ActionSchema;\n\n  /**\n   * 默认配置时追加的，如果更新配置想完全替换配置请配置为 true.\n   */\n  replaceChartOption?: boolean;\n\n  /**\n   * 不可见的时候隐藏\n   */\n  unMountOnHidden?: boolean;\n}\n\nconst EVAL_CACHE: {[key: string]: Function} = {};\n/**\n * ECharts 中有些配置项可以写函数，但 JSON 中无法支持，为了实现这个功能，需要将看起来像函数的字符串转成函数类型\n * 目前 ECharts 中可能有函数的配置项有如下：interval、formatter、color、min、max、labelFormatter、pageFormatter、optionToContent、contentToOption、animationDelay、animationDurationUpdate、animationDelayUpdate、animationDuration、position、sort\n * 其中用得最多的是 formatter、sort，所以目前先只支持它们\n * @param config ECharts 配置\n */\nfunction recoverFunctionType(config: object) {\n  ['formatter', 'sort', 'renderItem'].forEach((key: string) => {\n    const objects = findObjectsWithKey(config, key);\n    for (const object of objects) {\n      const code = object[key];\n      if (typeof code === 'string' && code.trim().startsWith('function')) {\n        try {\n          if (!(code in EVAL_CACHE)) {\n            EVAL_CACHE[code] = eval('(' + code + ')');\n          }\n          object[key] = EVAL_CACHE[code];\n        } catch (e) {\n          console.warn(code, e);\n        }\n      }\n    }\n  });\n}\n\nexport interface ChartProps\n  extends RendererProps,\n    Omit<ChartSchema, 'type' | 'className'> {\n  chartRef?: (echart: any) => void;\n  onDataFilter?: (config: any, echarts: any) => any;\n  onChartWillMount?: (echarts: any) => void | Promise<void>;\n  onChartMount?: (chart: any, echarts: any) => void;\n  onChartUnMount?: (chart: any, echarts: any) => void;\n  store: IServiceStore;\n}\nexport class Chart extends React.Component<ChartProps> {\n  static defaultProps: Partial<ChartProps> = {\n    replaceChartOption: false,\n    unMountOnHidden: false\n  };\n\n  static propsList: Array<string> = [];\n\n  ref: any;\n  echarts?: any;\n  unSensor: Function;\n  pending?: object;\n  pendingCtx?: any;\n  timer: ReturnType<typeof setTimeout>;\n  mounted: boolean;\n  reloadCancel?: Function;\n\n  constructor(props: ChartProps) {\n    super(props);\n\n    this.refFn = this.refFn.bind(this);\n    this.reload = this.reload.bind(this);\n    this.handleClick = this.handleClick.bind(this);\n  }\n\n  componentWillMount() {\n    const {config, api, data, initFetch, source} = this.props;\n\n    this.mounted = true;\n\n    if (source && isPureVariable(source)) {\n      const ret = resolveVariableAndFilter(source, data, '| raw');\n      ret && this.renderChart(ret);\n    } else if (api && initFetch !== false) {\n      this.reload();\n    }\n\n    config && this.renderChart(config);\n  }\n\n  componentDidUpdate(prevProps: ChartProps) {\n    const props = this.props;\n\n    if (isApiOutdated(prevProps.api, props.api, prevProps.data, props.data)) {\n      this.reload();\n    } else if (props.source && isPureVariable(props.source)) {\n      const prevRet = prevProps.source\n        ? resolveVariableAndFilter(prevProps.source, prevProps.data, '| raw')\n        : null;\n      const ret = resolveVariableAndFilter(props.source, props.data, '| raw');\n\n      if (prevRet !== ret) {\n        this.renderChart(ret || {});\n      }\n    } else if (props.config !== prevProps.config) {\n      this.renderChart(props.config || {});\n    } else if (\n      props.config &&\n      props.trackExpression &&\n      filter(props.trackExpression, props.data) !==\n        filter(prevProps.trackExpression, prevProps.data)\n    ) {\n      this.renderChart(props.config || {});\n    }\n  }\n\n  componentWillUnmount() {\n    this.mounted = false;\n    clearTimeout(this.timer);\n  }\n\n  handleClick(ctx: object) {\n    const {onAction, clickAction, data} = this.props;\n\n    clickAction &&\n      onAction &&\n      onAction(null, clickAction, createObject(data, ctx));\n  }\n\n  refFn(ref: any) {\n    const chartRef = this.props.chartRef;\n    const {chartTheme, onChartWillMount, onChartUnMount, env} = this.props;\n    let onChartMount = this.props.onChartMount;\n\n    if (ref) {\n      Promise.all([\n        import('echarts'),\n        import('echarts-stat'),\n        import('echarts/extension/dataTool'),\n        import('echarts/extension/bmap/bmap')\n      ]).then(async ([echarts, ecStat]) => {\n        (window as any).echarts = echarts;\n        (window as any).ecStat = ecStat;\n        let theme = 'default';\n\n        if (chartTheme) {\n          echarts.registerTheme('custom', chartTheme);\n          theme = 'custom';\n        }\n\n        if (onChartWillMount) {\n          await onChartWillMount(echarts);\n        }\n\n        (echarts as any).registerTransform(\n          (ecStat as any).transform.regression\n        );\n        (echarts as any).registerTransform((ecStat as any).transform.histogram);\n        (echarts as any).registerTransform(\n          (ecStat as any).transform.clustering\n        );\n\n        if (env.loadChartExtends) {\n          await env.loadChartExtends();\n        }\n\n        this.echarts = echarts.init(ref, theme);\n\n        if (typeof onChartMount === 'string') {\n          onChartMount = new Function('chart', 'echarts') as any;\n        }\n\n        onChartMount?.(this.echarts, echarts);\n        this.echarts.on('click', this.handleClick);\n        this.unSensor = resizeSensor(ref, () => {\n          const width = ref.offsetWidth;\n          const height = ref.offsetHeight;\n          this.echarts?.resize({\n            width,\n            height\n          });\n        });\n\n        chartRef && chartRef(this.echarts);\n        this.renderChart();\n      });\n    } else {\n      chartRef && chartRef(null);\n      this.unSensor && this.unSensor();\n\n      if (this.echarts) {\n        onChartUnMount?.(this.echarts, (window as any).echarts);\n        this.echarts.dispose();\n        delete this.echarts;\n      }\n    }\n\n    this.ref = ref;\n  }\n\n  reload(subpath?: string, query?: any) {\n    const {api, env, store, interval} = this.props;\n\n    if (query) {\n      return this.receive(query);\n    } else if (!env || !env.fetcher || !isEffectiveApi(api, store.data)) {\n      return;\n    }\n\n    clearTimeout(this.timer);\n    if (this.reloadCancel) {\n      this.reloadCancel();\n      delete this.reloadCancel;\n      this.echarts?.hideLoading();\n    }\n    this.echarts?.showLoading();\n\n    store.markFetching(true);\n    env\n      .fetcher(api, store.data, {\n        cancelExecutor: (executor: Function) => (this.reloadCancel = executor)\n      })\n      .then(result => {\n        isAlive(store) && store.markFetching(false);\n\n        if (!result.ok) {\n          return env.notify(\n            'error',\n            result.msg || '加载失败，请重试！',\n            result.msgTimeout !== undefined\n              ? {\n                  closeButton: true,\n                  timeout: result.msgTimeout\n                }\n              : undefined\n          );\n        }\n        delete this.reloadCancel;\n\n        const data = result.data || {};\n        // 说明返回的是数据接口。\n        if (!data.series && this.props.config) {\n          const ctx = createObject(this.props.data, data);\n          this.renderChart(this.props.config, ctx);\n        } else {\n          this.renderChart(result.data || {});\n        }\n\n        this.echarts?.hideLoading();\n\n        interval &&\n          this.mounted &&\n          (this.timer = setTimeout(this.reload, Math.max(interval, 1000)));\n      })\n      .catch(reason => {\n        if (env.isCancel(reason)) {\n          return;\n        }\n\n        isAlive(store) && store.markFetching(false);\n        env.notify('error', reason);\n        this.echarts?.hideLoading();\n      });\n  }\n\n  receive(data: object) {\n    const store = this.props.store;\n\n    store.updateData(data);\n    this.reload();\n  }\n\n  renderChart(config?: object, data?: any) {\n    config && (this.pending = config);\n    data && (this.pendingCtx = data);\n\n    if (!this.echarts) {\n      return;\n    }\n\n    const store = this.props.store;\n    let onDataFilter = this.props.onDataFilter;\n    const dataFilter = this.props.dataFilter;\n\n    if (!onDataFilter && typeof dataFilter === 'string') {\n      onDataFilter = new Function('config', 'echarts', dataFilter) as any;\n    }\n\n    config = config || this.pending;\n    data = data || this.pendingCtx || this.props.data;\n\n    if (typeof config === 'string') {\n      config = new Function('return ' + config)();\n    }\n    try {\n      onDataFilter &&\n        (config = onDataFilter(config, (window as any).echarts) || config);\n    } catch (e) {\n      console.warn(e);\n    }\n\n    if (config) {\n      try {\n        if (!this.props.disableDataMapping) {\n          config = dataMapping(\n            config,\n            data,\n            (key: string, value: any) =>\n              typeof value === 'function' ||\n              (typeof value === 'string' && value.startsWith('function'))\n          );\n        }\n\n        recoverFunctionType(config!);\n\n        if (isAlive(store) && store.loading) {\n          this.echarts?.showLoading();\n        } else {\n          this.echarts?.hideLoading();\n        }\n\n        this.echarts?.setOption(config!, this.props.replaceChartOption);\n      } catch (e) {\n        console.warn(e);\n      }\n    }\n  }\n\n  render() {\n    const {\n      className,\n      width,\n      height,\n      classPrefix: ns,\n      unMountOnHidden\n    } = this.props;\n    let style = this.props.style || {};\n\n    width && (style.width = width);\n    height && (style.height = height);\n\n    return (\n      <LazyComponent\n        unMountOnHidden={unMountOnHidden}\n        placeholder={\n          <div className={cx(`${ns}Chart`, className)} style={style}>\n            <div className={`${ns}Chart-placeholder`}>\n              <Spinner\n                show\n                icon=\"reload\"\n                spinnerClassName={cx('Chart-spinner')}\n              />\n            </div>\n          </div>\n        }\n        component={() => (\n          <div\n            className={cx(`${ns}Chart`, className)}\n            style={style}\n            ref={this.refFn}\n          />\n        )}\n      />\n    );\n  }\n}\n\n@Renderer({\n  test: /(^|\\/)chart$/,\n  storeType: ServiceStore.name,\n  name: 'chart'\n})\nexport class ChartRenderer extends Chart {\n  static contextType = ScopedContext;\n\n  componentWillMount() {\n    super.componentWillMount();\n    const scoped = this.context as IScopedContext;\n    scoped.registerComponent(this);\n  }\n\n  componentWillUnmount() {\n    super.componentWillUnmount();\n    const scoped = this.context as IScopedContext;\n    scoped.unRegisterComponent(this);\n  }\n}\n"
    ]
}